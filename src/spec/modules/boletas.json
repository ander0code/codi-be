{
  "paths": {
    "/boletas/{userId}/upload": {
      "post": {
        "summary": "Subir y procesar una boleta",
        "description": "Procesa una imagen de boleta mediante OCR, detecta el supermercado, clasifica productos, calcula impacto ambiental, genera sugerencias ecológicas y crea recomendaciones de productos alternativos con menor huella de carbono. Actualiza puntos verdes si es recibo verde.",
        "tags": ["Boletas"],
        "parameters": [
          {
            "in": "path",
            "name": "userId",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "ID del usuario en formato UUID",
            "example": "123e4567-e89b-12d3-a456-426614174000"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "boleta": {
                    "type": "string",
                    "format": "binary",
                    "description": "Archivo de imagen de la boleta (JPEG, PNG o PDF, máximo 10MB)"
                  }
                },
                "required": ["boleta"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Boleta procesada exitosamente con recomendaciones generadas",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "message": { "type": "string", "example": "Boleta procesada exitosamente" },
                    "data": { "$ref": "#/components/schemas/ProcesarBoletaResponse" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Error de validación (archivo no válido o sin productos detectados)",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "examples": {
                  "sinArchivo": {
                    "summary": "No se subió archivo",
                    "value": {
                      "success": false,
                      "message": "No se ha subido ninguna imagen"
                    }
                  },
                  "sinProductos": {
                    "summary": "No se detectaron productos",
                    "value": {
                      "success": false,
                      "message": "No se detectaron productos en la imagen"
                    }
                  },
                  "tipoInvalido": {
                    "summary": "Tipo de archivo no permitido",
                    "value": {
                      "success": false,
                      "message": "Tipo de archivo no permitido. Solo JPEG, PNG o PDF"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Usuario no autenticado",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        },
        "security": [
          {
            "bearerAuth": []
          }
        ]
      }
    },
    "/boletas/{boletaId}": {
      "get": {
        "summary": "Obtener detalle de una boleta procesada con recomendaciones",
        "description": "Retorna la información completa de una boleta previamente procesada, incluyendo productos, análisis de impacto ambiental, datos de la tienda, y recomendaciones de productos alternativos con menor huella de carbono basadas en la base de datos vectorial Qdrant.",
        "tags": ["Boletas"],
        "parameters": [
          {
            "in": "path",
            "name": "boletaId",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "ID de la boleta en formato UUID",
            "example": "a3f2c1e0-b4d5-4321-8765-1234567890ab"
          }
        ],
        "responses": {
          "200": {
            "description": "Detalle de boleta obtenido exitosamente con recomendaciones incluidas",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean", "example": true },
                    "message": { "type": "string", "example": "Detalle de boleta obtenido exitosamente" },
                    "data": { "$ref": "#/components/schemas/DetalleBoletaResponse" }
                  }
                },
                "examples": {
                  "boletaConRecomendaciones": {
                    "summary": "Boleta con recomendaciones de productos",
                    "value": {
                      "success": true,
                      "message": "Detalle de boleta obtenido exitosamente",
                      "data": {
                        "id": "a3f2c1e0-b4d5-4321-8765-1234567890ab",
                        "fechaBoleta": "2025-01-06",
                        "nombreTienda": "Tottus",
                        "logoTienda": "https://example.com/tottus-logo.png",
                        "total": 50.00,
                        "tipoAmbiental": "VERDE",
                        "urlImagen": "boleta_2025_01_06.jpg",
                        "productos": [
                          {
                            "id": "prod-uuid-1",
                            "nombre": "Leche Gloria Entera 1L",
                            "cantidad": 2,
                            "precioUnitario": 5.50,
                            "precioTotal": 11.00,
                            "factorCo2": 4.2,
                            "categoria": "Lácteos y Frescos",
                            "subcategoria": "Leches",
                            "marca": "Gloria"
                          }
                        ],
                        "analisis": {
                          "totalProductos": 5,
                          "co2Total": 23.45,
                          "co2Promedio": 4.69
                        },
                        "recomendaciones": [
                          {
                            "id": "rec-uuid-1",
                            "productoOriginal": {
                              "id": "prod-uuid-1",
                              "nombre": "Leche Gloria Entera 1L",
                              "co2": 4.2
                            },
                            "productoRecomendado": {
                              "nombre": "Leche Laive Light 1L",
                              "marca": "Laive",
                              "categoria": "Lácteos",
                              "tienda": "tottus",
                              "co2": 2.8
                            },
                            "mejora": {
                              "porcentaje": 33.33,
                              "co2Ahorrado": 1.4
                            },
                            "tipo": "ALTERNATIVA_MISMA_TIENDA",
                            "scoreSimilitud": 0.92
                          }
                        ],
                        "resumenRecomendaciones": {
                          "totalRecomendaciones": 3,
                          "co2TotalAhorrable": 5.2,
                          "porcentajeMejoraPromedio": 28.5
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Boleta no encontrada",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" },
                "example": {
                  "success": false,
                  "message": "Boleta no encontrada"
                }
              }
            }
          },
          "401": {
            "description": "Usuario no autenticado",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        },
        "security": [
          {
            "bearerAuth": []
          }
        ]
      }
    }
  },
  "schemas": {
    "ProductoClasificado": {
      "type": "object",
      "properties": {
        "nombre": {
          "type": "string",
          "example": "Leche Gloria Entera 1L",
          "description": "Nombre del producto identificado"
        },
        "precio": {
          "type": "number",
          "format": "float",
          "example": 3.50,
          "description": "Precio unitario del producto"
        },
        "cantidad": {
          "type": "integer",
          "format": "int32",
          "example": 1,
          "description": "Cantidad de unidades compradas"
        },
        "categoria": {
          "type": "string",
          "example": "Lácteos y Frescos",
          "description": "Categoría normalizada del producto"
        },
        "subcategoria": {
          "type": "string",
          "nullable": true,
          "example": "Leches",
          "description": "Subcategoría del producto (opcional)"
        },
        "marcaId": {
          "type": "string",
          "format": "uuid",
          "nullable": true,
          "example": "789e4567-e89b-12d3-a456-426614174003",
          "description": "ID de la marca del producto (opcional)"
        },
        "factorCo2": {
          "type": "number",
          "format": "float",
          "example": 2.5,
          "description": "Factor de CO2 del producto en kg CO2e"
        },
        "esLocal": {
          "type": "boolean",
          "example": false,
          "description": "Indica si el producto es de origen local"
        },
        "tieneEmpaqueEcologico": {
          "type": "boolean",
          "example": false,
          "description": "Indica si el producto tiene empaque ecológico"
        },
        "confianza": {
          "type": "number",
          "format": "float",
          "minimum": 0,
          "maximum": 1,
          "example": 0.89,
          "description": "Nivel de confianza de la clasificación (0-1)"
        }
      },
      "required": [
        "nombre",
        "precio",
        "cantidad",
        "categoria",
        "factorCo2",
        "esLocal",
        "tieneEmpaqueEcologico",
        "confianza"
      ]
    },
    "ProductoDetalle": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "example": "prod-uuid-123",
          "description": "ID único del producto en la base de datos"
        },
        "nombre": {
          "type": "string",
          "nullable": true,
          "example": "Leche Gloria Entera 1L",
          "description": "Nombre del producto"
        },
        "cantidad": {
          "type": "number",
          "format": "float",
          "example": 2,
          "description": "Cantidad de unidades compradas"
        },
        "precioUnitario": {
          "type": "number",
          "format": "float",
          "example": 3.50,
          "description": "Precio por unidad del producto"
        },
        "precioTotal": {
          "type": "number",
          "format": "float",
          "example": 7.00,
          "description": "Precio total (cantidad × precio unitario)"
        },
        "factorCo2": {
          "type": "number",
          "format": "float",
          "example": 2.5,
          "description": "Factor de CO2 del producto en kg CO2e por unidad"
        },
        "categoria": {
          "type": "string",
          "nullable": true,
          "example": "Lácteos y Frescos",
          "description": "Categoría del producto"
        },
        "subcategoria": {
          "type": "string",
          "nullable": true,
          "example": "Leches",
          "description": "Subcategoría del producto"
        },
        "marca": {
          "type": "string",
          "nullable": true,
          "example": "Gloria",
          "description": "Nombre de la marca del producto"
        }
      },
      "required": [
        "id",
        "nombre",
        "cantidad",
        "precioUnitario",
        "precioTotal",
        "factorCo2",
        "categoria",
        "subcategoria",
        "marca"
      ]
    },
    "RecomendacionItem": {
      "type": "object",
      "description": "Recomendación de producto alternativo con menor huella de carbono",
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "example": "rec-uuid-123",
          "description": "ID único de la recomendación"
        },
        "productoOriginal": {
          "type": "object",
          "description": "Información del producto original de la boleta",
          "properties": {
            "id": {
              "type": "string",
              "format": "uuid",
              "example": "prod-uuid-456",
              "description": "ID del producto original"
            },
            "nombre": {
              "type": "string",
              "example": "Leche Gloria Entera 1L",
              "description": "Nombre del producto original"
            },
            "co2": {
              "type": "number",
              "format": "float",
              "example": 4.2,
              "description": "CO2 del producto original en kg CO2e"
            }
          },
          "required": ["id", "nombre", "co2"]
        },
        "productoRecomendado": {
          "type": "object",
          "description": "Información del producto alternativo recomendado",
          "properties": {
            "nombre": {
              "type": "string",
              "example": "Leche Laive Light 1L",
              "description": "Nombre del producto recomendado"
            },
            "marca": {
              "type": "string",
              "nullable": true,
              "example": "Laive",
              "description": "Marca del producto recomendado"
            },
            "categoria": {
              "type": "string",
              "nullable": true,
              "example": "Lácteos",
              "description": "Categoría del producto recomendado"
            },
            "tienda": {
              "type": "string",
              "example": "tottus",
              "description": "Tienda donde está disponible (tottus, wong, vivanda, plazavea, metro)"
            },
            "co2": {
              "type": "number",
              "format": "float",
              "example": 2.8,
              "description": "CO2 del producto recomendado en kg CO2e (siempre menor que el original)"
            }
          },
          "required": ["nombre", "marca", "categoria", "tienda", "co2"]
        },
        "mejora": {
          "type": "object",
          "description": "Información sobre la mejora ambiental",
          "properties": {
            "porcentaje": {
              "type": "number",
              "format": "float",
              "example": 33.33,
              "description": "Porcentaje de reducción de CO2 respecto al producto original"
            },
            "co2Ahorrado": {
              "type": "number",
              "format": "float",
              "example": 1.4,
              "description": "Cantidad de CO2 ahorrado en kg CO2e"
            }
          },
          "required": ["porcentaje", "co2Ahorrado"]
        },
        "tipo": {
          "type": "string",
          "enum": [
            "ALTERNATIVA_MISMA_TIENDA",
            "ALTERNATIVA_OTRA_TIENDA",
            "PRODUCTO_ECO_EQUIVALENTE",
            "MARCA_SOSTENIBLE"
          ],
          "example": "ALTERNATIVA_MISMA_TIENDA",
          "description": "Tipo de recomendación basada en la tienda y características del producto"
        },
        "scoreSimilitud": {
          "type": "number",
          "format": "float",
          "minimum": 0,
          "maximum": 1,
          "example": 0.92,
          "description": "Score de similitud semántica del producto recomendado (0-1) calculado con embeddings"
        }
      },
      "required": [
        "id",
        "productoOriginal",
        "productoRecomendado",
        "mejora",
        "tipo",
        "scoreSimilitud"
      ]
    },
    "ResumenRecomendaciones": {
      "type": "object",
      "description": "Resumen agregado de todas las recomendaciones de la boleta",
      "properties": {
        "totalRecomendaciones": {
          "type": "integer",
          "format": "int32",
          "example": 5,
          "description": "Cantidad total de recomendaciones generadas para la boleta"
        },
        "co2TotalAhorrable": {
          "type": "number",
          "format": "float",
          "example": 8.5,
          "description": "Total de CO2 que se podría ahorrar en kg CO2e siguiendo todas las recomendaciones"
        },
        "porcentajeMejoraPromedio": {
          "type": "number",
          "format": "float",
          "example": 28.50,
          "description": "Porcentaje promedio de mejora de CO2 de todas las recomendaciones"
        }
      },
      "required": [
        "totalRecomendaciones",
        "co2TotalAhorrable",
        "porcentajeMejoraPromedio"
      ]
    },
    "AnalisisBoleta": {
      "type": "object",
      "properties": {
        "totalProductos": {
          "type": "integer",
          "format": "int32",
          "example": 12,
          "description": "Total de productos en la boleta"
        },
        "productosVerdes": {
          "type": "integer",
          "format": "int32",
          "example": 8,
          "description": "Cantidad de productos clasificados como ecológicos"
        },
        "porcentajeVerde": {
          "type": "number",
          "format": "int32",
          "minimum": 0,
          "maximum": 100,
          "example": 67,
          "description": "Porcentaje de productos verdes sobre el total"
        },
        "co2Total": {
          "type": "number",
          "format": "float",
          "example": 45.75,
          "description": "Total de CO2 de todos los productos en kg"
        },
        "co2Promedio": {
          "type": "number",
          "format": "float",
          "example": 3.81,
          "description": "Promedio de CO2 por producto en kg"
        },
        "tipoAmbiental": {
          "type": "string",
          "enum": ["VERDE", "AMARILLO", "ROJO"],
          "example": "VERDE",
          "description": "Clasificación ambiental de la boleta. VERDE: ≥60% productos verdes y CO2 promedio <4.0. AMARILLO: ≥30% productos verdes y CO2 promedio <7.0. ROJO: resto de casos"
        },
        "esReciboVerde": {
          "type": "boolean",
          "example": true,
          "description": "Indica si la boleta califica como recibo verde (otorga +1 punto verde al usuario)"
        }
      },
      "required": [
        "totalProductos",
        "productosVerdes",
        "porcentajeVerde",
        "co2Total",
        "co2Promedio",
        "tipoAmbiental",
        "esReciboVerde"
      ]
    },
    "AnalisisDetalleSimplificado": {
      "type": "object",
      "properties": {
        "totalProductos": {
          "type": "integer",
          "format": "int32",
          "example": 5,
          "description": "Cantidad total de productos en la boleta"
        },
        "co2Total": {
          "type": "number",
          "format": "float",
          "example": 23.45,
          "description": "Total de CO2 de todos los productos en kg"
        },
        "co2Promedio": {
          "type": "number",
          "format": "float",
          "example": 4.69,
          "description": "Promedio de CO2 por producto en kg"
        }
      },
      "required": ["totalProductos", "co2Total", "co2Promedio"]
    },
    "DetalleBoletaResponse": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "example": "a3f2c1e0-b4d5-4321-8765-1234567890ab",
          "description": "ID único de la boleta"
        },
        "fechaBoleta": {
          "type": "string",
          "format": "date",
          "nullable": true,
          "example": "2025-01-05",
          "description": "Fecha de emisión de la boleta"
        },
        "nombreTienda": {
          "type": "string",
          "nullable": true,
          "example": "Tottus",
          "description": "Nombre de la tienda donde se realizó la compra"
        },
        "logoTienda": {
          "type": "string",
          "nullable": true,
          "example": "https://example.com/tottus-logo.png",
          "description": "URL del logo de la tienda"
        },
        "total": {
          "type": "number",
          "format": "float",
          "example": 34.70,
          "description": "Monto total de la boleta en soles (PEN)"
        },
        "tipoAmbiental": {
          "type": "string",
          "enum": ["VERDE", "AMARILLO", "ROJO"],
          "example": "VERDE",
          "description": "Clasificación ambiental de la boleta según el impacto de los productos"
        },
        "urlImagen": {
          "type": "string",
          "nullable": true,
          "example": "boleta_2025_01_05.jpg",
          "description": "Nombre del archivo de imagen de la boleta original"
        },
        "productos": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/ProductoDetalle" },
          "description": "Listado de productos comprados en la boleta"
        },
        "analisis": {
          "$ref": "#/components/schemas/AnalisisDetalleSimplificado",
          "description": "Análisis simplificado del impacto ambiental de la boleta"
        },
        "recomendaciones": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/RecomendacionItem" },
          "description": "Listado de recomendaciones de productos alternativos con menor huella de carbono. Solo se generan para productos con CO2 > 3.0. Máximo 3 recomendaciones por producto."
        },
        "resumenRecomendaciones": {
          "$ref": "#/components/schemas/ResumenRecomendaciones",
          "description": "Resumen agregado de todas las recomendaciones de la boleta"
        }
      },
      "required": [
        "id",
        "fechaBoleta",
        "nombreTienda",
        "logoTienda",
        "total",
        "tipoAmbiental",
        "urlImagen",
        "productos",
        "analisis",
        "recomendaciones",
        "resumenRecomendaciones"
      ]
    },
    "ProcesarBoletaResponse": {
      "type": "object",
      "properties": {
        "boletaId": {
          "type": "string",
          "format": "uuid",
          "example": "a3f2c1e0-b4d5-4321-8765-1234567890ab",
          "description": "ID único de la boleta procesada y guardada en BD"
        },
        "analisis": {
          "$ref": "#/components/schemas/AnalisisBoleta",
          "description": "Análisis del impacto ambiental de la boleta"
        },
        "productos": {
          "type": "array",
          "items": { "$ref": "#/components/schemas/ProductoClasificado" },
          "description": "Listado de productos extraídos y clasificados de la boleta"
        },
        "sugerencias": {
          "type": "array",
          "items": { 
            "type": "string",
            "example": "Prioriza productos locales y de temporada"
          },
          "description": "Sugerencias ecológicas personalizadas generadas por IA",
          "minItems": 3,
          "maxItems": 3
        }
      },
      "required": ["boletaId", "analisis", "productos", "sugerencias"]
    }
  },
  "tags": [
    {
      "name": "Boletas",
      "description": "Endpoints para procesar boletas de compra: extracción OCR, clasificación de productos, análisis de impacto ambiental, generación de sugerencias ecológicas y recomendaciones de productos alternativos con menor huella de carbono basadas en base de datos vectorial Qdrant"
    }
  ]
}